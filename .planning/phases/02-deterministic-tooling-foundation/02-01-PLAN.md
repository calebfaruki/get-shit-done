---
phase: 02-deterministic-tooling-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/lib/toolkit.cjs
  - tests/toolkit.test.cjs
autonomous: true
requirements: [TOOL-01, TOOL-02, TOOL-03, TOOL-04]

must_haves:
  truths:
    - "atomicWrite writes file content atomically using temp-file-then-rename"
    - "atomicWrite cleans up temp file on failure"
    - "getCurrentCommitSHA returns the current git HEAD SHA"
    - "isCodebaseMapStale compares stored SHA against current HEAD and reports staleness"
    - "checkPlanningDirExists returns {passed, message} for .planning directory presence"
    - "checkFileExists returns {passed, message} for arbitrary file existence"
    - "checkMapNotStale returns {passed, message} for codebase map freshness"
    - "resolveModel returns correct model ID for agent type and profile"
    - "resolveModel falls back to hardcoded defaults when no config exists"
  artifacts:
    - path: "get-shit-done/bin/lib/toolkit.cjs"
      provides: "Core utility functions library"
      exports: [atomicWrite, getCurrentCommitSHA, isCodebaseMapStale, checkPlanningDirExists, checkFileExists, checkMapNotStale, resolveModel]
    - path: "tests/toolkit.test.cjs"
      provides: "TDD tests for all toolkit functions"
      min_lines: 150
  key_links:
    - from: "get-shit-done/bin/lib/toolkit.cjs"
      to: "fs.renameSync"
      via: "atomicWrite temp-file-then-rename pattern"
      pattern: "renameSync"
    - from: "get-shit-done/bin/lib/toolkit.cjs"
      to: "child_process.execSync"
      via: "git rev-parse HEAD for SHA retrieval"
      pattern: "git rev-parse HEAD"
    - from: "get-shit-done/bin/lib/toolkit.cjs"
      to: ".planning/model-config.json"
      via: "resolveModel config file lookup"
      pattern: "model-config\\.json"
---

<objective>
Build the core utility functions for the toolkit library: atomic file writes, git SHA staleness detection, prerequisite validators, and model resolution.

Purpose: Agents need deterministic, tested utility functions instead of ad-hoc implementations scattered across commands. This plan creates the foundation that todo CRUD (plan 02) builds on.

Output: `get-shit-done/bin/lib/toolkit.cjs` with exported functions and `tests/toolkit.test.cjs` with full TDD coverage.
</objective>

<execution_context>
@/Users/calebfaruki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/calebfaruki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-deterministic-tooling-foundation/02-CONTEXT.md
@.planning/phases/02-deterministic-tooling-foundation/02-RESEARCH.md
@get-shit-done/bin/lib/core.cjs
@get-shit-done/bin/lib/frontmatter.cjs
@tests/helpers.cjs
@tests/deletion-safety.test.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for all core toolkit functions</name>
  <files>tests/toolkit.test.cjs</files>
  <action>
Create `tests/toolkit.test.cjs` using the existing test patterns (node:test, node:assert, helpers.cjs patterns for temp dirs).

Test cases for each function:

**atomicWrite(targetPath, content):**
- Writes content to a new file successfully (returns `{success: true}`)
- File content matches what was written
- Overwrites existing file atomically
- Creates parent directory's file correctly (parent dir must exist — atomicWrite does NOT create dirs)
- Returns `{success: false, error: string}` when target directory doesn't exist
- Cleans up temp file on write failure (verify no `.tmp` files left behind)

**getCurrentCommitSHA(cwd):**
- Returns `{success: true, sha: string}` in a git repo (use the real project cwd)
- SHA is a 40-character hex string
- Returns `{success: false, error: string}` when cwd is not a git repo (use temp dir without git init)

**isCodebaseMapStale(cwd, storedSHA):**
- Returns `{stale: false, ...}` when storedSHA matches current HEAD
- Returns `{stale: true, currentSHA, storedSHA, ...}` when storedSHA differs
- Returns `{stale: null, error: ...}` when not in a git repo

**checkPlanningDirExists(cwd):**
- Returns `{passed: true, message: string}` when `.planning/` exists and is a directory
- Returns `{passed: false, message: string}` when `.planning/` doesn't exist
- Returns `{passed: false, message: string}` when `.planning` exists but is a file (not dir)

**checkFileExists(cwd, relativePath):**
- Returns `{passed: true, message: string}` when file exists
- Returns `{passed: false, message: string}` when file doesn't exist

**checkMapNotStale(cwd, mapPath):**
- Returns `{passed: true, ...}` when SHA in map file matches HEAD
- Returns `{passed: false, ...}` when SHA differs
- Returns `{passed: false, ...}` when map file doesn't exist
- Map file format: reads first line matching `sha: <hex>` from YAML frontmatter

**resolveModel(cwd, agentType):**
- Returns correct model for known agent type with default profile ('balanced')
- Returns 'inherit' for agents whose balanced profile maps to 'opus'
- Returns 'sonnet' for unknown agent types
- Reads profile from `.planning/model-config.json` when it exists
- Falls back to 'balanced' profile when config file is missing
- Falls back to 'balanced' profile when config file has invalid JSON

Each test file setup: use `fs.mkdtempSync` for isolated temp dirs (same pattern as deletion-safety.test.cjs). Clean up in afterEach.

Run tests: `node --test tests/toolkit.test.cjs` — ALL tests must FAIL (RED phase). The toolkit.cjs file should not exist yet.
  </action>
  <verify>Run `node --test tests/toolkit.test.cjs` and confirm all tests fail with "Cannot find module" or similar import errors.</verify>
  <done>All test cases written, all fail because toolkit.cjs doesn't exist yet.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — Implement toolkit.cjs with minimal code to pass all tests</name>
  <files>get-shit-done/bin/lib/toolkit.cjs, tests/toolkit.test.cjs</files>
  <action>
Create `get-shit-done/bin/lib/toolkit.cjs` as a single-file library. Zero external dependencies — Node.js stdlib only (fs, path, child_process, os).

**atomicWrite(targetPath, content):**
- Write to temp file in SAME directory as target: `.${basename}.${process.pid}.${Date.now()}.tmp`
- Same directory guarantees same filesystem device (avoids EXDEV errors)
- `fs.writeFileSync(tmpPath, content, 'utf-8')` then `fs.renameSync(tmpPath, targetPath)`
- On error: try to unlink temp file, return `{success: false, error: err.message}`
- On success: return `{success: true}`

**getCurrentCommitSHA(cwd):**
- `execSync('git rev-parse HEAD', {cwd, encoding: 'utf-8', stdio: ['pipe', 'pipe', 'pipe']}).trim()`
- Return `{success: true, sha}` or `{success: false, error: string}`

**isCodebaseMapStale(cwd, storedSHA):**
- Call getCurrentCommitSHA internally
- Compare, return `{stale: bool, currentSHA, storedSHA, message}` or `{stale: null, error}`

**checkPlanningDirExists(cwd):**
- `fs.statSync(path.join(cwd, '.planning'))` — check isDirectory()
- Return `{passed: bool, message: string}` — NO console.log, NO process.exit

**checkFileExists(cwd, relativePath):**
- `fs.statSync(path.join(cwd, relativePath))`
- Return `{passed: bool, message: string}`

**checkMapNotStale(cwd, mapPath):**
- Read map file, extract `sha:` from frontmatter
- Compare with getCurrentCommitSHA result
- Return `{passed: bool, message: string, currentSHA?, storedSHA?}`

**resolveModel(cwd, agentType):**
- Use MODEL_PROFILES table from existing core.cjs (copy the table, don't require core.cjs — toolkit.cjs is the new standalone library)
- Try reading `.planning/model-config.json` for `{model_profile: 'quality'|'balanced'|'budget'}`
- Default profile: 'balanced'
- Default models when no agent match: `{quality: 'opus', balanced: 'sonnet', budget: 'haiku'}`
- Convert 'opus' to 'inherit' (Claude Code convention — host provides the model)

Export all functions via `module.exports`.

Run `node --test tests/toolkit.test.cjs` — ALL tests must PASS (GREEN phase). If any fail, fix the implementation (not the tests) until green. If a test reveals an unreasonable expectation, adjust the test minimally and document why.
  </action>
  <verify>Run `node --test tests/toolkit.test.cjs` and confirm all tests pass. Also run `node --test tests/deletion-safety.test.cjs` to confirm no regressions.</verify>
  <done>All toolkit tests pass. All existing deletion-safety tests still pass. toolkit.cjs exports: atomicWrite, getCurrentCommitSHA, isCodebaseMapStale, checkPlanningDirExists, checkFileExists, checkMapNotStale, resolveModel.</done>
</task>

</tasks>

<verification>
1. `node --test tests/toolkit.test.cjs` — all tests pass
2. `node --test tests/deletion-safety.test.cjs` — no regressions
3. `node -e "const t = require('./get-shit-done/bin/lib/toolkit.cjs'); console.log(Object.keys(t))"` — lists all expected exports
4. Verify no `console.log` or `process.exit` in toolkit.cjs (library, not CLI)
5. Verify no `require` of external packages in toolkit.cjs
</verification>

<success_criteria>
- toolkit.cjs exists with 7+ exported functions
- All functions are pure (no side effects beyond file I/O)
- All validator functions return `{passed, message}` — never print or exit
- atomicWrite uses temp-file-then-rename pattern
- resolveModel reads config from `.planning/model-config.json`
- All tests pass, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/02-deterministic-tooling-foundation/02-01-SUMMARY.md`
</output>
